<template>
  <div>
    <input value="永夜" id="musicName"/>
    <button @click="this.play.bind(this)">播放</button>
    <button @click="this.pause.bind(this)">暂停</button>
    <button @click="this.start.bind(this)">开始</button>
    <button @click="this.stop.bind(this)">停止</button>
    <button @click="this.getMusic.bind(this)">getMusic</button>
    <!-- <audio src="http://localhost:3000/getParticalMusic?name=永夜.mp3"></audio> -->
  </div>
</template>

<script>
  import Grass from '@rustle/grass'
  import Hearken from '../src'
  import ajax from '../test/xhr'

  export default class Root extends Grass.Component {
    constructor () {
      super()
      this.Hearken = new Hearken.Media({ loop: true })
      this.stream = null
      this.index = 0
      window.h = this.Hearken
    }

    play () {
      if (this.Hearken) {
        this.Hearken.play()
      }
    }

    pause () {
      if (this.Hearken) {
        this.Hearken.pause()
      }
    }

    start () {
      if (this.Hearken) {
        this.Hearken.start(this.stream, 5, 20)
      }
    }

    stop () {
      if (this.Hearken) {
        this.Hearken.stop()
      }
    }

    getMusic () {
      this.index++
      const stream = this.stream = new Hearken.Stream('audio/mpeg')
      window.s = this.stream

      const name = this.index % 2 === 0
        ? 'airplanes'
        : 'airplanes'

      console.log(name);
      ajax('http://localhost:3000/getParticalMusic?name=' + name, (err, { response }, fn) => {
        if (err) throw err
        window.aa = response
        stream.append(response)
        fn()
      })

      ajax.end = () => stream.end()
      this.Hearken.start(stream, 5, 20).then(r => console.log(r))
      this.Hearken.on('playError', e => console.log(e))
    }
  }
</script>